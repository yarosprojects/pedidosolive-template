---
import { getSupabaseServerClient } from "../lib/supabase";

const { className = "" } = Astro.props;

const supabase = getSupabaseServerClient(Astro);
const { data: orders, error } = await supabase
    .from("orders")
    .select(
        `
    *,
    office:profiles (
      name,
      surname
    )
  `,
    )
    .order("created_at", { ascending: false });

if (error) {
    console.error(error);
}
---

<div class={className}>
    <div
        class="max-[880px]:grid grid max-[880px]:grid-cols-1 max-[1300px]:grid-cols-2 grid-cols-3 gap-6 place-items-center"
    >
        {
            orders?.map((order) => {
                const {
                    id,
                    company_name,
                    contact_name,
                    contact_surname,
                    contact_email,
                    contact_phone,
                    order_details,
                    created_at,
                    office_order_id,
                    isClient,
                    isDone,
                } = order;

                return (
                    <article class="max-[1300px]:w-full w-105 card opacity-0 transition-all duration-500">
                        <div class="flex flex-col">
                            {/* CARTA DE PEDIDO */}
                            <div
                                class="relative bg-white border border-black/10 shadow-md shadow-black/20 rounded-xl p-5 flex flex-col gap-4 transition-all overflow-hidden"
                                transition:name={`editar-pedido-${id}`}
                            >
                                {/* CLIENTE Y ESTADO DEL PEDIDO */}

                                <div class="flex justify-between items-start w-full">
                                    <div>
                                        <h3 class="text-base font-semibold uppercase tracking-wider text-gray-500">
                                            Cliente
                                        </h3>
                                        <p class="text-base font-medium text-gray-900 mt-1 company_name">
                                            {company_name}
                                        </p>
                                    </div>

                                    {isDone ? (
                                        <span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-700 font-medium">
                                            Finalizado
                                        </span>
                                    ) : (
                                        <span class="text-xs px-2 py-1 rounded-full bg-yellow-100 text-yellow-700 font-medium">
                                            Pendiente
                                        </span>
                                    )}
                                </div>

                                <div class="w-full h-px bg-black/10" />

                                {/* CONTACTO */}
                                <div class="flex flex-col">
                                    <h3 class="text-xs font-semibold uppercase tracking-wider text-gray-500">
                                        Contacto
                                    </h3>

                                    <div class="text-xs text-gray-800">
                                        {contact_name} {contact_surname}
                                    </div>

                                    <div class="flex flex-col text-xs text-gray-600 gap-1">
                                        <span>{contact_email}</span>
                                        <div class="flex flex-row gap-1 items-center">
                                            <span class="opacity-75">+34</span>
                                            <span>{contact_phone}</span>
                                        </div>
                                    </div>
                                </div>

                                {/* SEPARADOR */}
                                <div class="w-full h-px bg-black/10" />

                                {/* SERVICIO */}
                                <div class="flex flex-col gap-1">
                                    <span class="text-xs font-semibold uppercase tracking-wider text-gray-500">
                                        Servicio solicitado
                                    </span>

                                    <p class="text-sm text-gray-900 leading-relaxed bg-gray-500/8 px-4 py-3 rounded-xl">
                                        {order_details}
                                    </p>
                                </div>

                                {/* CARD FOOTER */}
                                <div class="flex justify-between items-center pt-3 text-xs text-gray-400">
                                    <span>
                                        {new Date(
                                            created_at,
                                        ).toLocaleDateString()}
                                    </span>

                                    {order.office ? (
                                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-blue-50 text-blue-900 text-xs font-medium">
                                            <i class="icon-[mdi--office-building]" />
                                            Oficina · {order.office.name}{" "}
                                            {order.office.surname}
                                        </span>
                                    ) : (
                                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-gray-100 text-gray-600 text-xs">
                                            <i class="icon-[mdi--account]" />
                                            Cliente
                                        </span>
                                    )}
                                </div>
                            </div>

                            {/* OPCIONES DE LA CARTA DE PEDIDO */}
                            <div class="w-full flex flex-row flex-wrap justify-start items-center p-2 gap-2">
                                {/* BOTÓN EDITAR */}
                                <a
                                    title="Editar pedido"
                                    href={`/dashboard/editar-pedido?card=${id}`}
                                    class="p-2 text-sm bg-[#013485]/10 text-[#013485] rounded-lg border border-[#013485]/10 hover:-translate-y-0.5 transition-transform cursor-pointer flex justify-center items-center"
                                >
                                    <i class="icon-[uil--edit] text-lg" />
                                </a>

                                {/* BOTÓN ELIMINAR */}
                                <form
                                    action="/dashboard/accion/eliminar-pedido"
                                    method="POST"
                                >
                                    <input type="hidden" name="id" value={id} />

                                    <button
                                        title="Eliminar pedido"
                                        type="submit"
                                        class="p-2 text-sm bg-red-500/30 text-red-900 hover:-translate-y-0.5 transition-transform cursor-pointer rounded-lg border border-red-500/30 flex justify-center items-center"
                                    >
                                        <i class="icon-[mi--delete] text-lg" />
                                    </button>
                                </form>

                                {/* BOTÓN DE MARCAR PEDIDO COMO REALIZADO O DESMARCAR COMO REALIZADO */}
                                {!isDone ? (
                                    <form
                                        action="/dashboard/accion/marcar-como-realizado"
                                        method="POST"
                                    >
                                        <input
                                            type="hidden"
                                            name="id"
                                            value={id}
                                        />

                                        <button
                                            title="Marcar como realizado"
                                            type="submit"
                                            class="
                                                text-nowrap
                                                md:gap-0 gap-1
                                                group flex justify-center items-center hover:gap-2 p-2
                                                bg-green-500/30 text-green-900
                                                border border-green-500/30 rounded-lg
                                                cursor-pointer
                                                transition-all duration-300 ease-out
                                                hover:-translate-y-0.5
                                            "
                                        >
                                            <i class="icon-[hugeicons--note-done] text-lg" />

                                            <span
                                                class="
                                                    md:overflow-hidden
                                                    md:max-w-0
                                                    md:opacity-0
                                                    opacity-100
                                                    md:whitespace-nowrap
                                                    md:transition-[max-width,opacity]
                                                    md:duration-300
                                                    md:ease-out
                                                    md:group-hover:max-w-45
                                                    text-sm
                                                    md:group-hover:opacity-100
                                                "
                                            >
                                                Marcar como realizado
                                            </span>
                                        </button>
                                    </form>
                                ) : (
                                    <form
                                        action="/dashboard/accion/marcar-como-realizado"
                                        method="POST"
                                    >
                                        <input
                                            type="hidden"
                                            name="id"
                                            value={id}
                                        />

                                        <button
                                            title="Desmarcar como realizado"
                                            type="submit"
                                            class="
                                                group md:gap-0 gap-1 p-2 text-sm bg-yellow-500/30 text-yellow-900 hover:-translate-y-0.5 
                                                transition-all cursor-pointer rounded-lg border border-yellow-500/30 
                                                flex justify-center items-center hover:gap-2 duration-300 ease-out
                                            "
                                        >
                                            <i class="icon-[tabler--x] text-lg" />
                                            <span
                                                class="
                                                    md:overflow-hidden
                                                    md:max-w-0
                                                    md:opacity-0
                                                    opacity-100
                                                    md:whitespace-nowrap
                                                    md:transition-[max-width,opacity]
                                                    md:duration-300
                                                    md:ease-out
                                                    md:group-hover:max-w-45
                                                    text-sm
                                                    md:group-hover:opacity-100
                                                "
                                            >
                                                Desmarcar como realizado
                                            </span>
                                        </button>
                                    </form>
                                )}
                            </div>
                        </div>
                    </article>
                );
            })
        }
    </div>
</div>

<script is:inline>
    document.addEventListener("astro:page-load", () => {
        const cards = Array.from(document.querySelectorAll(".card"));

        if (!cards) return;

        cards.forEach((card, index) => {
            card.style.transitionDelay = `${index * 120}ms`;
        });

        const observer = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        entry.target.classList.remove(
                            "opacity-0",
                            "translate-y-4",
                        );
                        entry.target.classList.add(
                            "opacity-100",
                            "translate-y-0",
                        );
                        observer.unobserve(entry.target);
                    }
                });
            },
            { threshold: 0.15 },
        );

        cards.forEach((card) => observer.observe(card));
    });
</script>
